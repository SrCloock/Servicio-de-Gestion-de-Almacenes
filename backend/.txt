// ============================================
// ‚úÖ 2. MIDDLEWARE DE AUTENTICACI√ìN MEJORADO
// ============================================
app.use((req, res, next) => {
  // ‚úÖ EXCLUIR RECURSOS EST√ÅTICOS Y RUTAS P√öBLICAS
  const publicPaths = [
    '/login', 
    '/', 
    '/api/diagnostic', 
    '/diagnostic',
    '/favicon.ico'
  ];
  
  // Excluir archivos est√°ticos (JS, CSS, im√°genes, etc.)
  const isStaticFile = req.path.startsWith('/assets/') || 
                      req.path.startsWith('/static/') ||
                      req.path.endsWith('.js') ||
                      req.path.endsWith('.css') ||
                      req.path.endsWith('.ico') ||
                      req.path.endsWith('.png') ||
                      req.path.endsWith('.jpg') ||
                      req.path.endsWith('.svg') ||
                      req.path.endsWith('.woff') ||
                      req.path.endsWith('.woff2') ||
                      req.path.endsWith('.ttf');

  if (publicPaths.includes(req.path) || isStaticFile) {
    console.log(`‚úÖ Ruta p√∫blica: ${req.path}`);
    return next();
  }

  const usuario = req.headers.usuario;
  const codigoempresa = req.headers.codigoempresa;

  if (!usuario || !codigoempresa) {
    console.error('üö® Faltan cabeceras de autenticaci√≥n:', {
      path: req.path,
      method: req.method,
      origin: req.headers.origin
    });
    return res.status(401).json({ 
      success: false, 
      mensaje: 'Faltan cabeceras de autenticaci√≥n (usuario y codigoempresa)' 
    });
  }

  req.user = {
    UsuarioLogicNet: usuario,
    CodigoEmpresa: parseInt(codigoempresa, 10) || 0
  };

  console.log(`üîí Usuario autenticado: ${usuario}, Empresa: ${codigoempresa}`);
  next();
});